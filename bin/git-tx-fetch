#!/bin/sh
#
# Copyright (c) 2010 Google Inc johnjbarton@google.com
# Google BSD license http://code.google.com/google_bsd_license.html

# Given: a local tree with .git-tx/<project> metadata directory
#           LOCAL_COMMIT points to the one less than last pulled commit
#           OTHER_COMMIT points to the other tree commit last pulled.
# Result: local tree updates on tx-<project> branch with patch from other
#           OTHER_COMMIT advances to HEAD on other tree
#           LOCAL_COMMIT unchanged

OPTIONS_SPEC="\
git tx-push  <projectName>

Squashes all changes on the transplanted subdirectory into a commit on the this repo
--
v,verbose            echo information
x,verbose_only       echo information then exit"

die() {
	echo >&2 "$@"
	exit 1
}

usage() {
	exec "$0" -h
}

. $(dirname $0)/git-sh-setup.sh

require_clean_work_tree "tx-fetch"

eval "$(echo "$OPTIONS_SPEC" | git rev-parse --parseopt -- "$@" || echo exit $?)"

get_repo_base() {
	(
		cd "`/bin/pwd`" &&
		cd "$1" || cd "$1.git" &&
		{
			cd .git
			pwd
		}
	) 2>/dev/null
}


PROJECT_NAME=

while [ "$#" -ne 0 ]; do
	case "$1" in 
 	-v|--verbose)
 		VERBOSE=yes
 		;;
    -x|--verbose_only)
        VERBOSE_ONLY=yes
        VERBOSE=yes
        ;;
 	--)                   # some kind of marker added by rev-parse
		shift
 	    if [ "$#" -ne 1 ]; then
 	      die "$# project required"
 	    fi
		PROJECT_NAME=$1
		break
		;;
	*)
		usage
		;;
	esac
	shift
done

if [ -z "$PROJECT_NAME" ]; then
  die "No project name"
fi

. $(dirname $0)/git-tx-setup 
DEBUG echo "git-tx-fetch ++++++++++++++++++++++"
setOtherPath

if [ "$VERBOSE" =  yes ]; then
  echo "git tx fetch to local directory $LOCAL_PREFIX"
  echo "git tx fetch from directory $OTHER_PATH"
  echo "git tx fetch from repo $OTHER_GIT_URL"
  echo "git tx fetch from directory of other git repo $OTHER_PREFIX" 
  echo "git tx fetch diff to commit $LOCAL_COMMIT"
  echo "git tx fetch diff from commit $OTHER_COMMIT"
fi

if [ "$VERBOSE_ONLY" = yes ]; then
  exit 0
fi

# ------------------ OTHER -----------------
# verify that the other tree is clean and we are up to date
#
CWD=$( pwd )
cd "$OTHER_PATH"
DEBUG echo "require clean tree in $( pwd )"
require_clean_work_tree "tx-fetch"

CURRENT_OTHER_BRANCH=`git symbolic-ref HEAD | sed -e 's/^.*\///'`

OTHER_GIT_DIR=$(git rev-parse --show-toplevel)
cd "$OTHER_GIT_DIR"

# verify that the other tree has our commit
#
DEBUG echo "require tx branch in other tree $( pwd )"
require_tx_branch "$OTHER_COMMIT"

git checkout $TX_BRANCH
git rebase $OTHER_BRANCH

# diff within the transplant
#
TMP_GIT_TX_PATCH=/tmp/git-tx-$$.patch
git diff --no-prefix "$OTHER_COMMIT".."$OTHER_BRANCH" "--" "$OTHER_PREFIX" > "$TMP_GIT_TX_PATCH"

DEBUG echo "fetch created patch from $( git log -1 --oneline $OTHER_COMMIT )" 

git checkout -q "$CURRENT_OTHER_BRANCH"

if [ -z "$(cat $TMP_GIT_TX_PATCH)" ]; then
  echo "Nothing to fetch, diff is empty"
  cd "$OTHER_GIT_DIR"
  advance_tx_branch "$OTHER_COMMIT"
  cd "$LOCAL_GIT_DIR"
  exit 0
fi

# -------------------- LOCAL ---------------
cd "$LOCAL_GIT_DIR"
cd "$LOCAL_PREFIX"

CURRENT_LOCAL_BRANCH=`git symbolic-ref HEAD | sed -e 's/^.*\///'`

DEBUG echo "require tx branch in $( pwd ) at $( git log -1 --oneline $LOCAL_COMMIT )"
require_tx_branch "$LOCAL_COMMIT"

git checkout "$TX_BRANCH" 

# patch this tree with changes from the other one, while at the prefix depth
#
patch < "$TMP_GIT_TX_PATCH"

DEBUG echo "fetch applied patch at $( git log -1 --oneline HEAD )"

# commit the changes
git add -A
git commit -m "tx-pull from $OTHER_GIT_URL $OTHER_PREFIX at $OTHER_COMMIT"

DEBUG echo "Applied patch from $TMP_GIT_TX_PATCH in $( pwd ), status:"
DEBUG git status
DEBUG git log -1 --oneline HEAD

git checkout -q "$CURRENT_LOCAL_BRANCH"

# ------------------ OTHER -----------------
cd "$OTHER_GIT_DIR"
advance_tx_branch "$OTHER_COMMIT"
# ------------------ LOCAL -----------------
cd "$LOCAL_GIT_DIR"

DEBUG echo "git-tx-fetch --------------------"
exit 0
